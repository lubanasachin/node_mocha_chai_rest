'use strict';

var getDb = require('mj-connect');

/**
 * get a user details from users collection
 * @params json: query, function: _cb
 * @returns 
*/
function findOne(query,_cb) {
	getDb(function(err, db) {
		if (err) {
			return _cb(err);
		}
		db.collection('users').find(query, function(err, results) {
			if (err) {
				return _cb(err);
			}
			results.toArray(function(err, items){
				if (err) {
					return _cb(err);
				}
				return _cb(null, items);
			});
		});
	});
}

/**
 * find all user details from users collection
 * @params function: _cb
 * @returns 
*/
function findAll(_cb) {
	getDb(function(err, db) {
		if (err) {
			return _cb(err);
		}
		db.collection('users').find({}, function(err, results) {
			if (err) {
				return _cb(err);
			}

			results.toArray(function(err, items){
				if (err) {
					return _cb(err);
				}
				return _cb(null, items);
			});
		});
	});
}

/**
 * save new user details into users collection
 * @params json: data, function: _cb
 * @returns 
*/
function save(data,_cb) {
	getDb(function(err, db) {
    	if (err) {
			return _cb(err);
    	}
		db.collection('users').insert(data, function(err, results) {
			if (err) {
				return _cb(err);
			}
			return _cb(null, results);
		});
	});
}

/**
 * update a user details into users collection
 * @params json: query, json: setData, function: _cb
 * @returns 
*/
function update(query,setData,_cb) {
	getDb(function(err, db) {
		if (err) {
			return _cb(err);
		}
		db.collection('users').update(query, setData, function(err, results) {
			if (err) {
				return _cb(err);
			}
			return _cb(null, results);
		});
	});
}

/**
 * remove all user details from users collection (used only for writing test cases)
 * @params function: _cb
 * @returns 
*/
function remove(_cb) {
	getDb(function(err, db) {
		if (err) {
			return _cb(err);
		}
		db.collection('users').remove({}, function(err, results) {
			if (err) {
				return _cb(err);
			}
			return _cb(null, results);
		});
	});
}

module.exports = {
	findOne: findOne,
	findAll: findAll,
	save: save,
	update: update,
	remove: remove
}

