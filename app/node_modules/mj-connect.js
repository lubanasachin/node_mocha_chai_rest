'use strict';

var MongoClient = require('mongodb').MongoClient,
	config = require('mj-config'),
	common = require('mj-common'),
	CONNECTING = false,
	dbConnObj;

exports = module.exports = getDb;

/**
 * create database connect when needed based on dbtoConnect passed
 * @param String dbtoConnect, callback function
 * return
*/
function getDb(done) {
  //if already connect to passed dbtoConnect
  if (dbConnObj) {
      common.log('info:: already connected to db');
      return done(null, dbConnObj);
    }

  if(CONNECTING === true) {
    common.log('info:: connection in progress to db');
    return queue.push(done);
    }

  CONNECTING = true;
  common.log('info:: creating new connection to db');

  var url = config.mongoDb;
  var mongoClient = new MongoClient();
  if(url == undefined){
    common.log('err:: Mongo database does not match with config file');
  }else{
    mongoClient.connect(url, function(err, db) {
      if (err) {
        common.log("err::"+err);
        return done(err);
      }
      dbConnObj = db;
      common.log('info:: connected to db');
      CONNECTING = false;
      done(null, dbConnObj);
    });
  } 
}
